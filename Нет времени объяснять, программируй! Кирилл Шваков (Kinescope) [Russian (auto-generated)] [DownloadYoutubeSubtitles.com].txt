Кирилл швакова кинескоп Кирилл сцена

[музыка]

твоя Доброе утро всем Кто пришёл Так

значит про что доклад написано хочу что

сказать сразу если кто-то слушал

вступление которое было с 10 утра то

Присоединяюсь к Яндекс софт нужно не

только использовать но и писать и рано

или поздно многие к этому

приходят к этому пришли мы то есть мы в

своей компании пишем очень-очень много

софта сами причём иногда

очень который Казалось бы писать не

нужно он есть и как к этому мы пришли

немножко сегодня об этом поговорим

собственно О чём доклад изначально

доклад должен быть о технологиях и

только о технологиях но получатся

поэтому он больше я Вер

себя так пропадает иногда Ну ничего

поехали о технологиях данные моментс на

самом деле очень много своих решений

которые написаны либо полностью с нуля

самими либо используя какие-то

библиотеки но не какой-то коробочный

продукт это и DNS и cdn и хранение

контента и различные библиотеки для

работы с

медиафорум

так было не всегда на самом деле вот

изначально когда проект разрабатывается

не стоит наверное и начинать делать

что-то из головы как бы соответственно

Мы так не делали если вернуться немножко

назад такая ретроспектива то был 2020

год Все ждали собственно Олимпиаду в

Токио кто-то сходил с ума а Мы начинали

писать вот так уло соответственно в этот

чудесный год все сидели по домам и кто

чем занимался мы писали

А что важно на самом деле При запуске

проекта это сроки Вот потому что мы

условно состоянии стартапа нам нужно

как-то быстро запуститься и совершенно

как бы точно мы не будем что-то ставлять

сами второе что важно - Это сроки сроки

сроки как бы ну вот другого в принципе

ничего нет как этого добиться добиться

на самом деле достаточно

просто первое должны быть понятны цели и

задачи с этим на самом деле у нас

проблем не было потому что мы прекрасно

понимали Какой должен быть у нас продукт

И что он должен делать Какой у него ль

то есть всё хорошо и было понимание

вообще задач на самом деле потому что мы

и до кинескопа в принципе занимались

чем-то похожим а надёжная опытная

команда она тоже У нас была у нас не

было с этим проблем наверное на старте

проекта это одна из самых очевидных и

больших таких проблем которы с которыми

сталкиваются люди когда что-то стартует

у нас с этим не было команда была до

кинескопа и мы двинулись в этот проект с

надёжными проверенными людьми

и всё было хорошо

технологии точно так же мы не стали

ничего думать мы посмотрели с чем Мы

работали до этого что мы хорошо знаем И

действительно хорошо знаем и стали

собственно это

использовать если говорить команду Я уже

сказал Да что она у нас была с этим у

нас проблем не было Но если у вас

надёжная команда знае что не будет

косяков У нас есть архитектурные косяки

прочее там кто-то что-то забыл не

подумал что-то сделал Но самое главное

по опыту вот Что вот могу сразу сказать

с чем сталкиваемся

мы у себя с чем сталкивался Я до этого и

с чем вообще сталкивался с какими

проблемами за последние там лет 20

разработки которые вот действительно

меня беспокоят это вот это вот а

разработчики не знают SQL

а не умеют не хотят думать о базе данных

из этого вылезает самое большое

количество проблем поэтому хотелось бы

помимо там знания какого-то языка

программирования чтобы знали что что-то

ещё и другое Поэтому не надо ставить

проверенные технологии что мы взяли мы

взяли DNS естественно нужен был какой-то

гео ДНС мы взяли Гугловский который был

Аа у нас сразу сразу же оговорюсь у нас

своё железо было изначально то есть мы

не используем никакой Cloud вот у нас

своя железная платформа мы находимся в

нескольких дата центрах и это было в

принципе практически самого старта

проекта поэтому у нас там bgp нека на

точках э собственно на машины которые

анонсируют в се эти там

стоят берды под ними стоит н под НМ

написаны какие-то на приложени были ВС

это общается с пасом для аналитики у нас

был кликхаус для хранения цеф Ну и

Понятно У на есть очереди и прочая

история там на и как-то так

вот то есть достаточно классический на

самом деле стек с которым Мы работали и

до и тут тут всё

хорошо это пра а это FreeBSD и jins вот

это хорошая связка её в своё время

использовал netflix Аа сейчас есть

компания Недавно смотрел доклад не помню

кто кто-то российский большой тоже

занимается по-моему чем-то с видео

связанным тоже пытаются сейчас делать

FreeBSD

anding удачи

вот что у нас получилось собственно Да

как бы что все же всем же интересно вот

мы что-то взяли собрались начали делать

Как бы хоп-хоп-хоп как бы что-то должно

получиться должен быть какой-то факап

или нет нет фапа не было у нас всё

получилось

вот

а Отмотай если в в 2020 году и там чуть

позже мы там рассказывали что мы там

платформа для интернета объединяем

что-то какие-то технологии да то сейчас

мы примерно выглядим так то есть у нас

большое количество клиентов в 2023 году

нас очень многие используют И на самом

деле если вы пользуетесь интернетом то

так или иначе скорее всего с

вероятностью 9999 там вы пользуетесь

нами ну Ну в том числе не только нами Да

ну где-то видите видео которое раздаётся

где-то смотрите онлайн-трансляции

которые раздаются через нас например вот

это ну и так

далее Далее как все поняли мы начали

расти

А рост Бывает разный и у нас он

собственно случился То есть у нас

начались появляться новые клиенты

какая-то база сформироваться вместе с

клиентами к нам пришла нагрузка больше

она начала расти у нас практически не

поменялась н команда у нас сильно Ну не

сильно Да у нас как бы стало больше

разработчиков которые занимаются фронт

эндом плеерами у нас стало больше

дизайнеров но Кэн Как таковой не сильно

рос он вырос у нас в очень хорошем

направлении У нас появился человек

который занимается Медиа форматами

делает это Наго ну как бы это всё хорошо

Это нам плюс и задачи собственно стали

расти бизнесов на

поддержку Ну вроде бы как бы всё хорошо

времени нет что-то пилим как бы да

задачи задачи клиенты клиенты и

собственно Где в этом месте взять найти

время либо вообще зачем взять и что-то

переписывать То есть если оно в принципе

работает да и работает относительно

неплохо приносит деньги и взять и

ввязаться разработку причём какого-то

Кастома который можно взять и поставить

Ну по идее бы казалось

Зачем вообще появляется какая-то

необходимость что-то пописать Ну это

хобби может

быть может быть обучение развития Чем

заняться тоже хороший пример иногда так

и делают потому что можем с этим тоже

сталкиваемся причём как бы не только это

если мы говорим там о сообщество это не

только развито на самом деле в

российском сообществе Почему взяли

что-то сделали как бы но в том числе там

и с иностранными компаниями причём даже

очень большими Недавно

мы были Ну смотрели да как

присутствовали можно сказа на

конференции там и доклады о этом были и

люди их публиковали они сделали софтвар

ную сеть это очень круто как бы но в их

задаче вообще не нужно

было

То есть это реально онн как бы там можно

было сделать всё за 2 дня как бы и не

париться но Сделали Сделали Молодцы

Хорошо и реальная необходимость Вот

реальная необходимость у нас была И на

самом деле как бы реальная необходимость

возникает не только у нас либо у вас там

либо ещё где-то иногда из этого

вырастают достаточно очень хорошие

серьёзные продукты которыми в том числе

мы пользуемся а потом отказываемся и

пишем что-то своё Ну как бы

круговорот хорошие примеры естественно

появился под реальные задачи писался

человеком которым с задачами сталкивался

и решал конкретные проблемы которые были

го кстати тоже в принципе появился не

просто так да мы там хотим изобрести ещё

один язык например как скалу в своё

время кликхаус та же самая история Да

там сла и на dbb вообще отличная штука

её любят все Даже те кто пользуется

прогрессом потому что это просто

произведение искусства как бы поэтому

советую почитать код посмотреть Если

интересно вы занимаетесь базами данных

работами с дисками либо ещё с чем-то

хорошая штука погружаетесь прямо

прекрасно сла тоже образец инженерного

искусства как собственно И многое что

они делают там фреймворке которые

выпускают в том числе под

неё дальше Собственно как понять что

время-то пришло что-то Как взять и

перепилить Ну понятно да то есть у вас

должна быть какая-то проблема и

существующее решение не

устраивает можно сказать вы можете Вот

не сказать что он меня не устраивает мне

не нравится потому что у него логотип

зелёный как бы ну

не прокатит нужно назвать конкретные

проблемы с которыми вы столкнулись и

главное вы не можете это решить вот

Никаким способом да то есть компетенции

не хватает

в например в языке Да в экосистеме

которая

есть Вы не можете там либо ещё что-то

сделать вы не можете намер поправить по

что архитектурно Это не проблема как бы

именно софта который вы используете

архитектурно именно архитектура

позволяет всти какие-то коррективы

которые нуж только Вам нет никах Ате

но больше вот Яндекс вписался сечас Наде

будет ВС лучше Ну становится больше тем

более как бы Бут поддерживать ком потому

что огромное количество интересных

решений которые забрасывают потому что

на самом деле это реально сложно то есть

мы сейчас ничего не осом по одной

простой причине потому что мы просто не

вытянем поддержку Хотя нам есть что за

возможно ког время

прид вот и нет человека который можно

было бы найть чтобы потом он что-то

переписал сделал Для вас например

удалённая команда это тоже кстати

хорошее решение потому что на Мы очень

долгое время когда у нас не было ж

инженеров которые занимаются фом у нас

были ребята из нидерланд которые решали

нам проблемы с фом они на самом деле

просто пишут цеф То есть одни из

разработчиков как бы и в какой-то момент

даже они столкнулись с проблемой которые

невозможно решить поэтому мы тоже до ксф

теперь смотрим косо то есть в какой-то

момент мы его тоже заменим

А что у вас должно быть да на момент

того принятия кото понимание Как

работает текущее решение если вы не

понимаете как работает текущее какое-то

решение Соф которое вы используете то вы

не сможете написать что-то лучше

изменить поправить как бы да то есть это

логично это логично но не всегда это так

на удивление То есть у Вас должен быть

понятны список требований к по

описание

Здрав

кание что у вас должно получиться ТЗ и

документация оно не должно у вас

появиться Если вы что-то разрабатываете

то есть потому что это такой комплексный

процесс взять и что-то написать то есть

нельзя просто сидеть вечером как бы и с

нуля То есть у вас всегда есть какие-то

там зарисовки на салфетке в виде план

диаграмм кому что нравится на самом деле

оно

поедет и должен быть список ограничений

То есть когда вы разрабатываете

технологию особенно когда вы например

делаете Это не в стол ради развлечения

ради ещё чего-то у вас есть какой-то

бизнес например под который вы там

задачу пишете у вас должно быть

понимание что эта штука может не решить

или что можно выкинуть поэтому как бы

ограничение Это хорошо и мы ими сильно

пользуемся в наших решениях потому что

мы выкидываем очень много что нам вообще

не надо мы вообще не

реализуем реальная история номер

один возможно хватит на номер два если

не хватит можно будет поговорить там как

мы сечас пишем свою распределенную

систему хранения данных

файлов у нас есть cdn и Казалось бы ну

простая штука поставили н как бы оно

работает на самом деле Да мы поставили н

поставили fre bsd И это всё работает ну

как бы проблем

нет почти Стандарт на то время просто

надёжно

производительно можно допили При желании

и в том числе для видеоконтента которым

мы занимаемся у нас так и было то есть

мы поставили н поставили модули оно всё

в принципе работало но в какой-то момент

нам стало этого не хватать новые клиенты

появились появились новые потребности и

хочеш этого не хочешь так как ты

находишься в

бизнесом это решать Да и как бы услужить

всем что нужно от CD это

производительность сколько трафика он

может прокачать ещё латен об этом чуть

позже какая-то его мко у на на самом

деле очень много объектов на ноду даже

сечас Вот потому что мы храним не только

свой контент который мы там

транскодирование

постоянный камис то есть в один сервер

это реально не влезает

а трафик нужно посчитать это кстати тоже

Интересная история потому что под счёт

трафика не тривиальная штука Как

оказалось бывает вот если мы берём НС и

с чем мы столкнулись после того как мы

начали писать потом всё это дело Наго то

проблемы с ростом количества объектов в

кэше собственно есть особенно если вы

используете его просто этот прокси кэш

ну оно сойдёт с ума Вот и Это неплохой н

просто немножко не под эти задачи

заточен как бы то есть у него немножко

другой

[музыка]

профайлер Ну в общем-то решаемо с

костылями ничего страшного так многие

работают сегментировать трафик

сложно Сложно отправлять поток метрик и

логов которые с него идут Вот потому что

запрос ли мы должны знать о них энное

количество информации в том числе

сколько данных мы передали Какой это был

клиент Какой это его проект например был

либо ещё какая-то история что это за

Медиа формат который был нужные метрики

тоже сложно

добавить стали искать альтернативы

альтернатива есть его используют фасли в

том числе разрабатывает фасли сильно

допили штука реально хорошая особенно

ло Вроде бы ничего но например в Осо у

не нет движка хранения хорошего он там

использует Map со своими там проблемами

то есть ЕС у вас контента Боше чем

оперативной памяти то у ва промы

вот опять же да Вопрос с метриками

логами он достаточно открыт для нас то

есть нужно тоже допивать каким-то образ

Он написан на у нас команда пишет на у

нас всё написано на совестно нам Ну были

бы специалисты которые его доливают это

размытие стека технологий риски

удорожания проекта поэтому берём пишем

свой Почему бы и

нет одна из главных задач как в нашем

случае разработки была да та случай

наверное любой что решение которое вы

пишете оно должно как бы решать проблемы

а не создавать их потому что бывает

наоборот То есть вы что-то написали а

потом Чите с этим годами или ещё

пытаетесь е не Только мучиться но Ита

продать как бы есть такие решения в ор и

в коммерческо

разработке поехали собственно что мы

сделали то есть чтобы решить как-то нашу

проблему мы разделили муху котлет То

есть у нас есть э сервера которые в

принципе умеют читать с диска и отдавать

контент если утрированно немножко

попробуем подальше вернуться более

глубоко к этому есть прокси сервера

которые принимают трафик есть менеджер

то есть с которым общаются и получают

некоторую информацию зонах там ещ

какие-то настройки вот чтобы всё на

обновлялось и есть какой-то Лектор

которы принимает поток логов есть прося

вот она принимает трафик отправляет в

нужный шарт То есть она умеет как бы

разобрать хттп и кинуть там куда нужно

умеет феры нормально потому что

э есть различные правила куда мы должны

отправить трафик если например под нами

сервер лежит вот

а и собственно есть метрики потому мы

понимаем что вообще происходит как бы и

можем сразу же как бы вклиниться если

понять что наш софт как-то ведёт себя не

так то мы сразу запиливать решаем и на

метрике в принципе мо може повесить

алерты выглядит Обычно это как-то так то

есть у нас есть Дыши на весь наш сов

который мы пишем есть там алерты и

прочая Это история Дальше

сами достаточно простая штука это

написано уже повторюсь

Наго Ну что мы сделали чтобы решить все

эти проблемы там с мелкими файлами проче

этой истории мы решили для себя что

каждый диск у нас по большому счёту это

просто блочно устройство на котором один

файл Там несколько

терабайт У нас есть индексы в памяти

чтобы можно было сразу быстро сделать

понять на каком диске это у тебя лежит а

открыть Файлик и собственно отправить

его ну открыть нужное место в файле как

бы сик нуть и отдать Вот это общая

очередь на запись это для нас тоже важно

чтобы уметь работать с HDD у нас это

очень просто сделано на самом деле вот

прелесть го что там есть очень простые

решения которые на других языках сложно

реализовать у есть трейдо о которым тоже

поговорить

вот зде вот хоро ВС есть это очень

сильно Томы про создам одну рутину когда

мы поднимаем какой-то файл У нас есть он

Да например там вше его нет на сервере

пришёл запрос Мы видим что нет мы

начинаем его скачивать мы его скачали мы

помещаем его в рутину это общая очередь

каждое устройство слушает эту рутину

какой из них свободно то начинает

писать чтобы уметь работать с обычными

дисками

SSD сразу скажу почему так потому что

это дешевле вот если в нас засунуть SSD

мы будем работать лучше если в нас не

засунуть SSD то в принципе тоже всё

работает хорошо у нас на рынке один из

самых низких lenc

сходов вот а и мы умеем делать бач из

чанков потому что у нас бывает поток

например лайва которая сейчас идёт это

поток маленьких маленьких файлов чтобы

не было рандомного чтения слишком

большого куда-то мы там пересунути

Мы немножко храним в памяти потом их

склеиваем и одним бам пишем на диск

получается неплохо На самом деле то есть

мы сильно этим делом как бы

оптимизировали историю Сония дис с

рандомным вот опять же мы умеем

раздавать из

памяти Казалось бы тоже хорошая история

но чуть позже вернёмся вот что не

всегда то что кажется ломко

Логично логи то есть там обыч мы

собираем У нас есть тоже очередь на

запись логов в памяти та же самая рутина

придумывает вот мы раз либо в какой-то

момент Флам Либо мы Флам если набрали ба

там больше определённого количества

запросов мы его собираем и отправляем

сервер чтобы он там уже его принял и

записал

Сха мы умеем хранить Мета информацию для

файлов это пря

оказало Нежин это можем потому что мы

думали Ну как бы ну что ну эж обычный Ну

что мы его там файл пришли записали как

бы и всё здорово как бы вот а оказалось

Раз уж мы его запили у нас стали

появляться задачи А почему бы файлы не

записать какую-то дополнительную мето

информацию чтобы потом её где-то не

искать например

А где этот Файлик был прио тачен На

какого клиента чтобы условно говоря не

искать это там в домене не искать это в

урлейка

всю нужную нам Мета информацию и прямо

пишем её и

это тоже нас отчасти сильно

выручает и мы этим активно пользуемся и

мы опять же мы видим все метрики которые

у нас есть система потому что метрики

реально выручают если у вас нет метрик

Если вы не видите что происходит внутри

вашего по это кстати одна из многих

задач Почему тоже некоторые вещи решаем

потому что непонятно что о происходит

это очень круто Ну там помимо простых

алертов которые есть просто иногда можно

посмотреть глазами и увидеть какую-то

проблему которые возникают а они

периодически на самом деле возникают То

есть можно из этого какие-то аномалии

наблюдать потому что не всегда понятно

что происходит то есть например если мы

просто собираем метрики операционной

системы там может быть всё очень хорошо

у нас такой случай

был раньше мы покупали железо обычно

одинаковое Ну когда можно было покупать

железо вот потом начались проблемы с

закупками это было на самом деле до

года проблемы с железом начались гораздо

раньше у всех причём потому что стало

его нехватка Поэтому как-то вот потом

это ВС усугубляется Вот

и если раньше мы покупали там супер

микру какое-нибудь и оно было всё

одинаковое его одинаково настраивали

вливали Вот тут у нас появляются старые

старые разные сервера разные жёсткие

диски и кстати тоже хорошо что это на

Соф поэтому некоторые вели Так что разе

ки ме втыкать разного вендора Вообще

разные сервера могут быть так

вот всё хорошо но один сервер у нас

настроили как-то криво Вот потому что мы

не используем рейды потому что они как

бы нам во-первых не нужны во-вторых от

них большой оверхед но у нас умудрились

при настройке при сетап нового сервера

закатить его так что мы стали

использовать какую-то историю

сварным контроллером который находился

на нём И если трафик на сервер стал

по-моему где-то около 10 Гигабит то есть

что в принципе немного для нас сервера

отдавать начинались чудеса чудеса вообще

проявлялись совершенно другим образом

клиент написал говорит У меня какие-то

проблемы с таймаута То есть у меня

контент долго отдаётся как бы

а на сервере полно памяти

свободной всё неплохо по цпу в принципе

всё неплохо как бы да хорошо

а но ползёт ДАД и реально Мы видим что

скорость вот дауда конкретно Вот на этом

сервере она

плавает мы тут же коррелирует С трафиком

смотрим Что так быть не должно В итоге в

чём в общем-то была

история мы давали на конкретный диск

системы нагрузку то есть свила история

Какая эти 10 Гигабит давались там

большей части с одного диска Ну понятно

что с диска столько не отдать он

отдавался там ша операционной системы

тем не менее но вот это вот хардвар

сорная штуковина которая была настроена

она это дело не тянула И вышивала вообще

весь сервер то есть нас начинались

проблемы

там сетевой подсистемой с дисковой

подсистемой вот в итоге перестали его

поставили как всё стало нормально

поэтому метрики важно как это выглядит

это выглядит примерно так там их больше

Вот кстати у

нас косяк вот можно сразу посмотреть в

том числе когда что-то нами то есть это

на самом деле может быть наша проблема

может быть проблема какого-то клиента

которы свои о нам Отт это в принципе

тоже достаточно неплохо детек что там

всё это разбито по клиентам Ну в смысле

там по доменам прочей истории можно

посмотреть но такие штуки Веды на них

можно

алеть тоже самое там по самим Жам То

есть можно мониторить память диски то

что мы используем мы на самом деле в

чему ещё интересно мы никак не можем

справиться с ситуацией очень смешная на

самом деле ситуация с выпадением дисков

Ну то есть они выпадают как бы ничего

страшного но прислать л что у тебя там

диск сгорел как бы иногда не вполне

возможно то есть он как бы есть система

его видит вот

а какие-то экспортёры отдают что диск

есть всё как бы норм Но на самом деле

уже не норм То есть он он Мёртвый как бы

да он либо в ушёл как бы и В некоторых

случаях как бы для нас нормально а В

некоторых случаях он вообще не работает

Вот и сейчас мы сами собираем активные

девайсы в сервисах которые работают с

большим массивом дисков Вот и собираемся

всё-таки переходить на то что мы их сами

всё равно чекаем потому что наша система

их чекает и мы уже больше будем на это

ориентироваться чем пытаться админов

заставить как-то там какую-то логику

придумать там писать в диске там ещё

что-то их как-то опрашивать потому что

это в принципе не работает и они убьют

на это больше времени чем мы как бы

начнём с вами

отдавать Так давайте к го вернёмся

потому что конференция про го а не

только про это всякие такие интересные

штуки давайте

а когда Мы начинали проектировать нашу

систему мы сразу же отказались от

стандартного ТТП сервера он в го очень

неплохой как и много из стандартной

библиотеки на самом деле что очень

хорошего есть в у него очень хорошая

стандартная библиотека и она реально

крутые интерфейсы То есть когда ты

пишешь потом свой код ты как бы не

хочешь делать сильно

хуже Поэтому зачастую получается неплохо

вот ну там с разным переменным успехом

но тем не менее Вот А почему собственно

мы не использовали ТТП сервер он не имед

Лины для наших задач то есть количество

rps на самом деле у нас не такое большое

То есть у нас сервер может пролететь там

не знаю там Пару десятков тысяч это в

принципе наверное съезд стандартный

Вот

Но у нас очень много контента который мы

передаём соответственно нам нужно

практически на всё сипу мы используем

это кстати of Go если у него была другая

модель работы с памятью такой бы истории

не было но Что есть то есть мы ширу tcp

коннекты вот у

нас

своя своя логика просто у на пу открытых

коннекто у нас там Тай Свои Свои и проще

нам мы понимаем как их лучше подстроить

и стандартно этого точно не даст У нас

естественно кэш открытых файлов потому

что файлики открывать туда-сюда очень

дорого особенно когда у вас там 1000

запросов могут прийти как бы ну нет

А у нас есть зеро

копи вот в этом месте так Ага вот в этом

месте про Зро копии и буферы и прочую

эту история на самом деле будет доклад

чтобы как бы не повторяться вос раз

называется будет доклад сегодня или

завтра Я кстати не знаю когда а будет

рассказывать человек Он тоже занимается

Медиа форматами и у него будет история

про а копии вот эти вот буферизированный

ввод-вывод он будет это более как

[музыка]

бы глубоко рассказывать советую сходить

как бы там там там расскажут здесь не

будем Вот

Но про зеро копи так туды сюды Так

давайте вот зеро копи история затравки

заодно сходите Посмотрите у нас есть

прокси Что делает прокси а он принимает

трафик разбирает п запрос отправляет его

в какой-то там вот по tcp Берт НС и

отправляет его выше Казалось бы просто

вот действительно просто чем в Стандарт

библиотеке используются вот эти вот

парсы они в принципе неплохие Вот но нас

напрягала Какая

история напрягала н потому что нам важно

не только много контента нам важно

отдать его быстро и тем более получить

какой-то первый байт клиенту всё-таки си

типа за скорость вот а медленный CD мало

кому нужен на самом деле даже если через

можно отдать много трафика

а смотрим на реквесты и понимаем что у

нас что-то не так Ну много на самом деле

как бы То есть 200 миллисекунд по де пй

процентили как бы много вот

а опять же юзаем ppr смотрим Потом

смотрим глазами что мы делали мы А у нас

свой веб-сервер простой написанный

вообще потому что мы видео отдаём по ХП

1.1 вот там

никакого блокирования запросов нет то

есть пришёл конект открыли начали лить

туда контент всё просто вот

а приходит запрос Мы обычно стандартным

Разбираем ТП там пас КСТ вот получаем

его выбираем там по какой-то логике

backend ccp соединение и в это

соединение пишем здесь проблем нет

запросы обычно приходят они очень

маленькие либо там тоже Какие одно и

тоже там заголовки и всё больше ничего

нету вот мы получаем респонс и просто

делаем респонс который есть у него есть

метод Write и мы пишем в Connect как бы

и в принципе всё здорово то есть мы

получили респонс получили с него

какие-то Данные сняли метрики записали

нужные нам историю которая там с него

была нужна и отправили клиенту и и

забыли и вот и 200 миллисекунд это

кстати если вы используете какой-то

сервер там м написанно на Go особенно

который говорит что он очень

производительный как бы там трафик там

ещё какие-то есть вот они используют

стандартные из Тила вот этот Проси вот

это оно можете потом КСТ сделать Если

захотите одно по

участвуете история Какая стандартный не

отправляет условно то как бы там

копирует в

Connect данные из-под себя Он копирует

их копирует сначала в память то есть из

US мы поднимаем то есть

обыч вот такого можно

избежать на самом деле там давно-давно в

Go был по request который добавил рако

методы То есть это либо Сефа если мы

работаем с файли ком либо с Да если мы

работаем сеть сеть Вот но внутри её

копия можно поковыряться он там

проверяет интерфейс если интерфейс

совпал то типа всё О'кей как бы

отправляет Вот Но в НС райте стандартном

настолько далеко Body Во что-то

запихнуть что как бы до него не

Достучаться что он соответствует этому

интерфейсу Поэтому там идёт как бы

стандартный R Right loop и мы получаем

Вот эту вот

историю Скорее всего Скорее всего

насколько я помню А у нас прокси

выглядит так когда он передаёт несколько

Гигабит в секунду То есть это

потребление памяти приложени и как бы

его респонс ну собственно видим да как

бы после особенно зеро копи мы память

практически не используем потому что мы

грубо говоря Что делаем при зеро копи мы

говорим вот у тебя есть один дескриптор

вот у тебя есть другой дескриптор ты там

самим разбирается операционную система

то есть мы так делаем это и для файлов и

мы так делаем для коннекто поэтому здесь

мы не проса с точки зрения го то есть

здесь мы не ловим вот эти вот эффекты

там когда мы Тамга коллектором боремся

ещё с какой-то историей здесь о нас

вобще как бы никак не относится то есть

отдал и

забыл если нет бизова а тоже самое да то

есть если мы знаем Сколько нам нужно

данных прочитать лучше прочитать сразу

столько Потому что если мы

читаем по чуть-чуть то это огромное

количеств

иже

Дели так только последня запись на диск

уже говорил пишем только последовательно

поэтому мы можем использовать хорды

поэтому у нас а стоимость решения в

деньгах а сильно ниже Вот поэтому можем

потратить эти деньги на костыля решени А

дальше их масштабировать просто в такая

машинки Вот получается выгодно и

походили в удовольствие и Компания

получила

деньги сложности то есть Куда уж без них

но если мы говорим Ого вот а о чём же

ещё то наверное Краеугольный камень -

Это работа с памятью в го мы руками не

работаем с памятью Ну почти но сейчас

арены появились Но это нельзя сказать

что это работа с памятью Ну такое ну

идея на самом деле старая давно вот а

висело чтобы можно было выделить

какую-то область памяти куда всё

запихать да и чтобы рш колектор на не

ходил а потом разом всё хлопнуть а для

ряда вещей

О'кей Вот но собственно Garbage колектор

- это такая Круговая штука из-за которой

идут потом все

проблемы То есть никаких там сложных

структур в памяти в нашем случае сразу

же говорю То есть Вполне себе для ваших

решений это может подойти мы как самые

умные когда стартовали ж напомню Что у

нас там 250 плюс 1000 объектов памяти

или миллионов короче много на самом деле

Вот мы написали дерево Ну причём было

такой как бы

чисто потренироваться грубо говоря

разбавить память написали дерево чтобы

хранить индекс памяти как бы всё хорошо

начало заливаться пря работает работат

достаточно быстро вот количество

объектов в НМ увеличилось увеличилось

увеличилось потом прош так бум и нам

ударило по цпу и собственно и паузы

пошли как бы и соответственно всё это

работать перестало самое

смешное пытались инженери сначала и

подумать как ещё там на самом деле

простой был

вот как как с этим быть и пытались там

написать на си потом забить Но это

неудобно деплоить и ещё всякие истории

вот в итоге просто вяли

Ну попробовать Блин у хватит бороться

как Давайте просто возьмём в запишем

ключ значение как бы всё и оно блин

взяло и

поехало Ну как бы

бывает нужны синглы опять же тоже самое

мы выделяем память какую-то лучше её не

отдавать сразу вот если у нас есть

какой-то объект либо там байты ещё

что-то вот это всё в Сингапуре хранится

чтобы каждый раз как колектор не пытался

это дело вычищать мы это пере используем

постоянно

вот поэтому у нас каких таких больших

проблем с памятью

Нет какие ещ сложности в го столкнулись

Ну с какого-то момента весь трафик

передаётся

шифрованный и соответственно мы написали

своё решение хотелось бы

подключить сертификат и поехать то есть

мы всё равно бы написали свой веб-сервер

написали там работу с этой штукой и

почему бы нет попробовали всё работает с

коробки

прям хорошо отличный интерфейс

са касаемо Вот именно стандарт

библиотеки интерфейсов причём не только

стандарт библиотеки Но на самом деле

много библиотек которые осные они очень

хорошо

сделаны Я не имею в виду там

внутренность Да именно интерфейс очень

круто с ним приятно работать как бы и

там видно опыт То есть например мне

кажется п занимался Пак насколько я не

помню ну по большей части вот У чувака

дофига опыта поэтому он опыт взял туда

перенёс это реально круто сделано

а динамический выбор сертификатов то

есть мы реально можем написать хранилище

какой-то сертификат и без всяких там

перезагрузок

а подменять сертификаты это прямо очень

удобно как бы было бы для нас вот и

прямо прекрасно но есть некоторые

проблемы это очень медленно То есть это

реально очень медленно как бы если брать

любые другие решения то есть поставить

Термини нха прокси либо ещё что-нибудь

вот го проиграет причём проиграет очень

сильно если вы занимаетесь Если вы

пытаетесь доста много трафика это будет

плохо то есть там даже не какие-то

проценты То есть это прямо разы может

быть у вас съест весь пу вот как бы вот

совсем Всё у нас было плохо потому что

если по профилировать то опять же там

пошли

бинты вот опять же пошло куча

памяти к Вам пришёл рш коллектор он вам

помог есть решение если мы говорили

окопе и соответственно когда можем

что-то делегировать операционной системе

то в какой-то момент в линуксе И не

только в линуксе появилась история с тмл

tls тоже самое на самом деле а ядро

сейчас понимает как работать с тлм то

есть там достаточно современ версия там

13 ну как бы это нормально уже вот там

ещё лет сать назад было не очень как бы

сейчас совсем Всё хорошо практически у

всех есть соответственно вы покрывали

как бы клиентов причём подавляющее

большинство Как это работает то есть у

вас открывается сот

тесовский Ну внутри ядра Вот вы работать

с ним как обычно То есть вы ничего не

видите Вы просто скормили там сертификат

сертификат набор байт и он умеет причём

настолько умеет хорошо что если у Вас

например нормальные сетевые карты там

какие носовски то вы можете прямо

Термини не только в ядре но вы можете

Термини трафик на сетевой карте вот

а жутко производительно если вам нужно

дофи трафика обрабатывать Ну на самом

деле там всё очень просто там есть

Арский про пря

прилеп к к сетевой карте и толь умеет TS

вот Казалось бы вот оно вот оно счастье

как бы и оно было очень близко Но его

нет в го Мы первые озаботились с этой

проблемой есть ию на гитхабе вот причём

самое смешное что ию сделали чуваки из

Гугла которые написали другим из Гугла

которые пишут как они такие

вот в общем о сечас висит если оно

появится в го это будет всем прям Профит

на самом деле то есть одна из больших

проблем то есть это решит кучу проблем

для тех кто занимается балансировкой

трафика А кто как и мы например

занимается отдачей трафика и это было бы

прямо очень круто но нет и нет притом

есть на Just for fun Попробовать там

человек то в тот момент занимался как

раз Го разработкой именно ТЛ Он у себя

там в блоке выложил что в принципе в

принципе это работает как бы можно

сделать вот но прокш решения

нет сам себе проблема вернёмся к отдаче

с памяти у нас тут у нас иногда

возникают какие-то проблемы не проблемы

у нас возникают нестандартные ситуации

если обычно у нас как бы есть некоторая

сезонность трафика в том числе по дням

по времени суток то иногда возникают

события какие-то большие например ла

трансляции Когда в тебя пролетает там не

знаю там плюс там 150 Гбит например ну

как бы это видно А Бывает такое что вот

те прилете трансляция а в этот момент

ещё какая-то рекламная сетка Начала

раздавать трав Вот тебе ещё там например

там 100 Вот

и тут можно посмотреть интересное когда

такое случается

А такие случаи бывают можно взять

включить ппв потому что вго на самом

деле одна из самых прекрасных штук - это

а профилирование всё работа с коробки

взял включил ещё вон картинку вывел и

прекрасно а в этот момент мы примерно

отдавали из памяти и из диска одинаковое

количество данных Но насколько мы видим

А из памяти мы сильно провисали Казалось

бы из памяти быстро а но не всегда то

что кажется на самом деле так и есть

опять же да мы очень сильно провеса где

если мы отдаём из памяти то мы копируем

из памяти GO Да из юзерс кой памяти р

спейса в Space дальше отдаём оно там

пишется в случае отдачи с диска мы опять

же используем Z копи Он кстати даже

здесь есть есть вон там вот вот

называется так мы используем заро копи и

не тащим себе в память данные чтобы

потом снова их куда-то отдать

вот поняли свой

косяк поэтому

А поэтому Сейчас как у нас будут

выделены сервера которые как раз для

отдачи лайва они стали ещё проще это

опять же да об ограничениях Мы из ТП

выкинули даже поддержку н то есть он

вообще ничего не умеет умеет нять запрос

никак не думать что там Range пришёл не

Range пришёл там какую-то часть файлика

и какую-то часть файлика он хочет как бы

прям взяли отдали то что есть потому что

мы понимаем что там будет маленький

кусочек лежать который нужно отдать весь

то есть сильно упростили У нас нет

никакого персин cash То есть ты его

ребутнуть есть э Файлик на диски обычные

кольцевой буфер Пишем с файла от начала

до конца Когда заканчивается Начинаем

писать с начала и затираем то что есть

Вот тебе вытеснение всё просто нет

никакого шарди очередей на запись вообще

тупой Всё

просто так если вдруг осталось время а

его не осталось вот поэтому подведём

итоги если слайд был заготовлен потому

что было понятно что это будет первый

Олег затянет Да и вообще

вот если что можно поговорить там про

другие штуки Кабу если у нас получилось

то и вас получится На самом деле потому

сложного нет обычно проблемы на самом

деле которые инженер встречаемся они

очень простые то есть какие-то базовые

вещи например

что нужно уметь как бы данные должны

быть сортировать Окей Вы можете в них

там быстро найти данные должны быть

фиксированного размера поэтому вы можете

эффективно их хранить на диске там или в

памяти либо ещё гдето быстро к ним

получить доступ Ну то есть вот вот ще

банальна любое решение которое вы

делаете Да там должно быть

аргументировано а нужно разбираться то

что ты делаешь тоже Казалось бы банально

и нерешаемых задач на самом деле не

существует вот мы пробовали сами то есть

если есть какая-то задача Мы её решим э

это может занять больше времени Иногда

сильно больше времени Вот иногда

некоторые задачи не делаются там за день

иногда за месяц иногда даже за год и это

вполне себе нормально То есть если как

бы ценность решения есть то можно его

делать и 2 года Вот а если что-то не

работает то это на самом деле не

означает что проблема конкретно как бы в

вас но может означать такое тоже бывает

то есть нужно профилировать это всегда

есть то есть можно насколько угодно

иметь огромное количество опыта и

накосячить прям вот прямо на простейшем

и это в принципе нормально вот в этом

нас спасает что с такими косяками

метрики которые мы собираем У нас их

много и на

всё профилирование это всё видно в го

это прям

даёт огромный Профит Все врут нужно

понимать когда вы приходите на

конференцию читаете статьи смотрите

бенчмарки либо ещё какая-то история

зачастую там

неправда причём неправда может быть от

начала и до конца то есть нужно все всё

проверять то есть нельзя бы в что-то

поставить как бы оно начнёт у вас

работать взять какую-то библиотеку и у

вас там полетело как бы всегда

встречаются какие-то косяки вот

встречается не то как это работает Как

это описано и так далее То есть опыт и

понимание того что если Вы что-то к себе

внедряет выстрелить в ногу вот причём

даже об этом рассказали что все у всех

всё хорошо Не Вот и потом придётся это

править Вот то есть поддерживать либо

там своё Либо вы как раз

запёк

дытей так время наверное у нас всё Если

есть вопросы попросили QR

код

Спасибо

Кирилл


